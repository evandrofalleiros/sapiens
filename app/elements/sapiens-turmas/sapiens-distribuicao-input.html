<dom-module id="sapiens-distribuicao-input">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>
     
    <paper-input-autocomplete 
      id="docente-{{index}}"
      label="Docente" 
      value="{{docente}}" 
      source="{{docentes}}" 
      suggestions-in-overlay="true" 
      search-property="nome"
      value-prop="nome"
      class="flex autocomplete" 
      empty-callback="[[_emptyCallback]]"
      required>
    </paper-input-autocomplete>

    <paper-icon-button icon="">Limpar</paper-icon-button>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'sapiens-distribuicao-input',

      properties: {
        docente: {
          type: Object,
          observer: '_docenteChanged',
          notify: true
        },

        disciplina: {
          type: Object,
          notify: true
        },

        turma: {
          observer: '_turmaChanged'
        }   
      },

      /* Chamado quando o usuário seleciona uma turma para edição */
      _turmaChanged: function(turma){
        if (turma.__firebaseKey__){

          var self = this;
          var ref = new Firebase('https://blazing-inferno-2038.firebaseio.com');

          ref.child('distribuicao/' + this.turma.__firebaseKey__)
            .orderByChild('disciplina')
            .equalTo(this.disciplina.key)
            .on('value', function(snapshot){

              if(snapshot.exists()){
                self.distribuicao = snapshot.val().toArray()[0];
                var key = self.distribuicao.docente;
                var docente = self.docentes.filter(function(d){
                  return d.key == key;
                })[0];

                self.docente = docente;
              }else{
                self.docente = {};
              }            
            });
        }
      },

      _docenteChanged: function(docente){
        // verificar se um docente foi passado como responsável
        // isso acontece em _turmaChanged

        var urlBase = 'https://blazing-inferno-2038.firebaseio.com/distribuicao/';
        var ref = new Firebase(urlBase + this.turma.__firebaseKey__);
        var distKey = this.disciplina.key;
        var self = this;

        if (!this.docente.isEmpty()){
          ref.orderByChild('disciplina').equalTo(distKey).on('value', function(d){
            if(d.exists()){
              var distribuicao = d.val().toArray()[0];

              ref.child(distribuicao.key).on('value', function(snapshot){
                if(snapshot.exists() && !docente.isEmpty()){ // update docente
                  var dist = snapshot.val();

                  // troca de docente responsável por uma disciplina    
                  if (!(dist.docente === docente.key)){
                    var key = snapshot.key();
                    
                    var docenteKey = distribuicao.docente.__firebaseKey__;
                    distribuicao.docente = docenteKey;

                    ref.child(key).update(distribuicao);  
                  }            
                }                
              });
            } else {
              // disciplina sem docente responsável
              if(!self.docente.isEmpty()){

                ref.push().set({
                  docente: docente.__firebaseKey__,
                  disciplina: self.disciplina.key
                });

                // atualizar carga horária docente
                var refDocentes = new Firebase('https://blazing-inferno-2038.firebaseio.com');
                var cargaDocenteAtual = docente.carga || 0;
                var novaCarga = cargaDocenteAtual + parseInt(self.disciplina.aulas);
                var docenteKey = docente.__firebaseKey__;

                refDocentes.child('docentes').child(docenteKey).update({
                  carga: novaCarga
                });     
              }
            }
          });           
        }
      },

      ready: function(){
        var self = this;

        // atualizar carga horária docente quando o input fica vazio
        this._emptyCallback = function(){
          var baseUrl = 'https://blazing-inferno-2038.firebaseio.com';
          var docente = self.docente.__firebaseKey__;
          var refDocente = new Firebase(baseUrl + '/docentes/' + docente);
          var refTurma = new Firebase(baseUrl + '/distribuicao/' + self.turma.__firebaseKey__ + '/' + self.distribuicao.key); 

          if(!self.docente.isEmpty()){

            // atualizar a carga horária semanal docente
            refDocente.once('value', function(snapshot){
              if(snapshot.exists){
                var cargaDocente = snapshot.val().carga;
                var cargaDisciplina = self.disciplina.aulas;

                self.docente = {};

                refDocente.update({
                  carga: cargaDocente - cargaDisciplina
                });

                // remover a distribuição da coleção de distribuições de aula
                refTurma.remove();  
              }          
            }); 
          }      
        }
      }
    });
  })();
  </script>
</dom-module>
